<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">

  <!-- GitHub Pages 用 base -->
  <base href="/hiro-san-z-reco/">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>山行記録 - 年別 | hiro-sanの山歩き</title>

  <link rel="stylesheet" href="CSS/style.css">
  <link rel="icon" href="favicon.ico">
</head>

<body>
  <!-- 共通ヘッダー -->
  <div id="header"></div>

  <main class="container main-content">
    <!-- ブレッドクラム -->
    <nav class="breadcrumb"></nav>

    <h1>山行記録 - 年別</h1>
    <p>
      年ごとに分類された山行記録です。
      ラベルをクリックすると対応する記事一覧が表示されます。
    </p>

    <div style="display:flex; gap:20px; flex-wrap:wrap;">

      <!--
        年別ラベルは Blogger の投稿ラベルから自動生成する。
        手動ラベルは以下の理由で廃止：
         - 年追加忘れ防止
         - 表記ゆれ事故防止
         - 長期運用での保守性確保
        ※ 復活させる場合は Git 履歴を参照
      -->
      <div class="label-buttons" id="year-labels-auto">
        <span class="label-placeholder">年別データを準備中…</span>
      </div>

      <!-- 記事リスト -->
      <div class="list-box" id="latest-list">
        <h3 id="list-title">最新5件</h3>
        <ul></ul>
        <p><a id="more-link" href="#" target="_blank">▶ もっと見る</a></p>
      </div>

    </div>
  </main>

  <!-- 共通フッター -->
  <div id="footer"></div>

  <!-- 共通JS -->
  <script src="JS/include.js"></script>

  <!-- 共通初期化 + ブレッドクラム -->
  <script>
    loadHeaderFooter();
    initNavToggle();

    renderBreadcrumb([
      { label: "ホーム", url: "index.html" },
      { label: "山行記録", url: "records/index.html" },
      { label: "年別" }
    ]);
  </script>

  <!-- Blogger ラベル別 最新5件取得 -->
  <script>
    const params = new URLSearchParams(window.location.search);
    const labelName = params.get("label") || "2025";

    document.getElementById("list-title").textContent =
      labelName + " の最新5件";

    const feedUrl =
      "https://hiro-san-163.blogspot.com/feeds/posts/default/-/" +
      encodeURIComponent(labelName) +
      "?alt=json&max-results=5";

    const moreUrl =
      "https://hiro-san-163.blogspot.com/search/label/" +
      encodeURIComponent(labelName);

    document.getElementById("more-link").href = moreUrl;

    fetch(feedUrl)
      .then(r => r.json())
      .then(data => {
        const posts = data.feed.entry || [];
        let html = "";
        posts.forEach(post => {
          const title = post.title.$t;
          const link = post.link.find(l => l.rel === "alternate").href;
          const date = new Date(post.published.$t).toLocaleDateString();
          html += `<li><small>${date}</small> <a href="${link}" target="_blank">${title}</a></li>`;
        });
        document.querySelector("#latest-list ul").innerHTML =
          html || "<li>記事が見つかりません</li>";
      })
      .catch(() => {
        document.querySelector("#latest-list ul").innerHTML =
          "<li>記事が見つかりません</li>";
      });
  </script>

  <!-- 年別ラベル自動生成（体感ゼロ設計・150件版） -->
  <script>
  (function () {

    const container = document.getElementById("year-labels-auto");
    if (!container) return;

    function loadYearLabels() {
      const years = new Set();

      const feedUrl =
        "https://hiro-san-163.blogspot.com/feeds/posts/default" +
        "?alt=json&max-results=150";

      fetch(feedUrl)
        .then(r => r.json())
        .then(data => {
          const entries = data.feed.entry || [];

          entries.forEach(entry => {
            (entry.category || []).forEach(cat => {
              if (/^\d{4}$/.test(cat.term)) {
                years.add(cat.term);
              }
            });
          });

          if (years.size === 0) {
            container.innerHTML =
              "<span class='label-placeholder'>年別データが見つかりません</span>";
            return;
          }

          const sorted = [...years].sort((a, b) => b - a);

          container.innerHTML = sorted.map(y =>
            `<a href="records/year.html?label=${y}">${y}</a>`
          ).join("");
        })
        .catch(() => {
          container.innerHTML =
            "<span class='label-placeholder'>年別データを取得できません</span>";
        });
    }

    // 体感ゼロ：ブラウザの空き時間に実行
    if ("requestIdleCallback" in window) {
      requestIdleCallback(loadYearLabels);
    } else {
      setTimeout(loadYearLabels, 200);
    }

  })();
  </script>

</body>
</html>
